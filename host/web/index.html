<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Paper Device Management</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        .firmware-state-ok { color: #198754; }
        .firmware-state-pending { color: #fd7e14; }
        .firmware-state-started { color: #0d6efd; }
        .firmware-state-failed { color: #dc3545; }
        .device-card { transition: transform 0.2s; }
        .timestamp { font-size: 0.85em; color: #6c757d; }
    </style>
</head>
<body>
    <div id="app">
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container-fluid">
                <span class="navbar-brand">
                    <i class="bi bi-display"></i>
                    E-Paper Device Management
                </span>
                <div class="d-flex">
                    <button class="btn btn-outline-light btn-sm me-2" @click="refreshDevices">
                        <i class="bi bi-arrow-clockwise"></i>
                        Refresh
                    </button>
                    <button class="btn btn-primary btn-sm" @click="showCreateModal">
                        <i class="bi bi-plus-lg"></i>
                        Add Device
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="container-fluid py-4">
            <!-- Status Messages -->
            <div v-if="message" class="alert" :class="messageClass" role="alert">
                <i class="bi" :class="messageIcon"></i>
                {{ message }}
                <button type="button" class="btn-close" @click="clearMessage"></button>
            </div>

            <!-- Device Grid -->
            <div v-else class="row g-4">
                <div v-for="device in devices" :key="device.device_id" class="col-md-6 col-lg-4">
                    <div class="card device-card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="card-title mb-0">
                                <i class="bi bi-display me-2"></i>
                                {{ device.device_friendly_name }}
                            </h6>
                            <span class="badge bg-secondary">ID: {{ device.device_id }}</span>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-6">
                                    <small class="text-muted">Firmware</small>
                                    <div class="fw-bold">v{{ formatFirmware(device.desired_firmware) }}</div>
                                    <small v-if="device.reported_firmware !== device.desired_firmware" class="text-warning">
                                        Current: v{{ formatFirmware(device.reported_firmware) }}
                                    </small>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Status</small>
                                    <div class="fw-bold" :class="'firmware-state-' + device.firmware_state.toLowerCase()">
                                        <i class="bi" :class="getFirmwareIcon(device.firmware_state)"></i>
                                        {{ device.firmware_state }}
                                    </div>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-6">
                                    <small class="text-muted">Check-in Interval</small>
                                    <div class="fw-bold">{{ device.checkin_interval }}s</div>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Last Heartbeat</small>
                                    <div class="timestamp">{{ formatTimestamp(device.last_heartbeat) }}</div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-6">
                                    <small class="text-muted">Next Expected</small>
                                    <div class="timestamp">{{ formatTimestamp(device.expected_heartbeat) }}</div>
                                    <div v-if="isOverdue(device.expected_heartbeat)" class="text-danger small">
                                        <i class="bi bi-exclamation-triangle"></i>
                                        Overdue
                                    </div>
                                </div>

                                <div class="col-6">
                                    <small class="text-muted">Battery Voltage</small>
                                    <div class="fw-bold">{{ +((device.vbat_mv/1000.0).toFixed(4)) }}V</div>
                                </div>
                            </div>

                            <div class="row mb-3" v-if="device.display_type || device.image_url || device.rotation">
                                <div class="col-6" v-if="device.display_type">
                                    <small class="text-muted">Display Type</small>
                                    <div class="fw-bold">{{ formatDisplayType(device.display_type) }}</div>
                                </div>
                                <div class="col-6" v-if="device.rotation">
                                    <small class="text-muted">Rotation</small>
                                    <div class="fw-bold">{{ formatRotation(device.rotation) }}</div>
                                </div>
                            </div>

                            <div class="row mb-3" v-if="device.image_url">
                                <div class="col-12">
                                    <small class="text-muted">Image URL</small>
                                    <div class="small text-truncate" :title="device.image_url">
                                        <a :href="device.image_url" target="_blank" rel="noopener noreferrer">
                                            {{ device.image_url }}
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="btn-group w-100" role="group">
                                <button class="btn btn-outline-primary btn-sm" @click="editDevice(device)">
                                    <i class="bi bi-pencil"></i>
                                    Edit
                                </button>
                                <button class="btn btn-outline-danger btn-sm" @click="confirmDelete(device)">
                                    <i class="bi bi-trash"></i>
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Empty State -->
                <div v-if="devices.length === 0" class="col-12">
                    <div class="text-center py-5">
                        <i class="bi bi-display" style="font-size: 3rem; color: #dee2e6;"></i>
                        <h3 class="text-muted mt-3">No devices found</h3>
                        <p class="text-muted">Get started by adding your first e-paper device.</p>
                        <button class="btn btn-primary" @click="showCreateModal">
                            <i class="bi bi-plus-lg"></i>
                            Add Your First Device
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Device Modal -->
        <div class="modal fade" id="createModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-plus-lg me-2"></i>
                            Add New Device
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form @submit.prevent="createDevice">
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="newDeviceId" class="form-label">Device ID</label>
                                <input type="number" class="form-control" id="newDeviceId"
                                       v-model.number="newDevice.device_id" required min="1">
                                <div class="form-text">Unique identifier for the device</div>
                            </div>
                            <div class="mb-3">
                                <label for="newDeviceName" class="form-label">Device Name</label>
                                <input type="text" class="form-control" id="newDeviceName"
                                       v-model="newDevice.device_friendly_name" required maxlength="255">
                                <div class="form-text">Human-readable name for the device</div>
                            </div>
                            <div class="mb-3">
                                <label for="newDesiredFirmware" class="form-label">Desired Firmware Version</label>
                                <input type="text" class="form-control" id="newDesiredFirmware"
                                       v-model="newDevice.desired_firmware" required min="1">
                                <div class="form-text">Target firmware version for the device</div>
                            </div>
                            <div class="mb-3">
                                <label for="newCheckinInterval" class="form-label">Check-in Interval (seconds)</label>
                                <input type="number" class="form-control" id="newCheckinInterval"
                                       v-model.number="newDevice.checkin_interval" required min="10" max="86400">
                                <div class="form-text">How often the device should check in (10-86400 seconds)</div>
                            </div>
                            <div class="mb-3">
                                <label for="newImageUrl" class="form-label">Image URL</label>
                                <input type="url" class="form-control" id="newImageUrl"
                                       v-model="newDevice.image_url" placeholder="https://example.com/image.png">
                                <div class="form-text">URL from which to fetch the image for this device</div>
                            </div>
                            <div class="mb-3">
                                <label for="newDisplayType" class="form-label">Display Type</label>
                                <select class="form-select" id="newDisplayType" v-model="newDevice.display_type">
                                    <option :value="null">-- Select Display Type --</option>
                                    <option value="EPD_TYPE_GDEY029T71H">2.9" B/W (GDEY029T71H)</option>
                                    <option value="EPD_TYPE_GDEM035F51">3.5" 4-color (GDEM035F51)</option>
                                    <option value="EPD_TYPE_GDEY029F51">2.9" 4-color (GDEY029F51)</option>
                                    <option value="EPD_TYPE_GDEM075F52">7.5" 4-color (GDEM075F52)</option>
                                    <option value="EPD_TYPE_WS_75_V2B">7.5" 2-color + red (WS_75_V2B)</option>
                                </select>
                                <div class="form-text">Type of e-paper display attached to this device</div>
                            </div>
                            <div class="mb-3">
                                <label for="newRotation" class="form-label">Display Rotation</label>
                                <select class="form-select" id="newRotation" v-model="newDevice.rotation">
                                    <option value="ROTATE_0">0°</option>
                                    <option value="ROTATE_90">90°</option>
                                    <option value="ROTATE_180">180°</option>
                                    <option value="ROTATE_270">270°</option>
                                </select>
                                <div class="form-text">Rotation angle for the display</div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary" :disabled="creating">
                                <span v-if="creating" class="spinner-border spinner-border-sm me-2"></span>
                                <i v-else class="bi bi-plus-lg me-2"></i>
                                {{ creating ? 'Creating...' : 'Create Device' }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Edit Device Modal -->
        <div class="modal fade" id="editModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-pencil me-2"></i>
                            Edit Device
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form @submit.prevent="updateDevice">
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Device ID</label>
                                <input type="text" class="form-control" :value="editingDevice.device_id" disabled>
                                <div class="form-text">Device ID cannot be changed</div>
                            </div>
                            <div class="mb-3">
                                <label for="editDeviceName" class="form-label">Device Name</label>
                                <input type="text" class="form-control" id="editDeviceName"
                                       v-model="editingDevice.device_friendly_name" required maxlength="255">
                            </div>
                            <div class="mb-3">
                                <label for="editDesiredFirmware" class="form-label">Desired Firmware Version</label>
                                <input type="text" class="form-control" id="editDesiredFirmware"
                                       v-model="editingDevice.desired_firmware" required min="1">
                            </div>
                            <div class="mb-3">
                                <label for="editCheckinInterval" class="form-label">Check-in Interval (seconds)</label>
                                <input type="number" class="form-control" id="editCheckinInterval"
                                       v-model.number="editingDevice.checkin_interval" required min="10" max="86400">
                            </div>
                            <div class="mb-3">
                                <label for="editImageUrl" class="form-label">Image URL</label>
                                <input type="url" class="form-control" id="editImageUrl"
                                       v-model="editingDevice.image_url" placeholder="https://example.com/image.png">
                                <div class="form-text">URL from which to fetch the image for this device</div>
                            </div>
                            <div class="mb-3">
                                <label for="editDisplayType" class="form-label">Display Type</label>
                                <select class="form-select" id="editDisplayType" v-model="editingDevice.display_type">
                                    <option :value="null">-- Select Display Type --</option>
                                    <option value="EPD_TYPE_GDEY029T71H">2.9" B/W (GDEY029T71H)</option>
                                    <option value="EPD_TYPE_GDEM035F51">3.5" 4-color (GDEM035F51)</option>
                                    <option value="EPD_TYPE_GDEY029F51">2.9" 4-color (GDEY029F51)</option>
                                    <option value="EPD_TYPE_GDEM075F52">7.5" 4-color (GDEM075F52)</option>
                                    <option value="EPD_TYPE_WS_75_V2B">7.5" 2-color + red (WS_75_V2B)</option>
                                </select>
                                <div class="form-text">Type of e-paper display attached to this device</div>
                            </div>
                            <div class="mb-3">
                                <label for="editRotation" class="form-label">Display Rotation</label>
                                <select class="form-select" id="editRotation" v-model="editingDevice.rotation">
                                    <option value="ROTATE_0">0°</option>
                                    <option value="ROTATE_90">90°</option>
                                    <option value="ROTATE_180">180°</option>
                                    <option value="ROTATE_270">270°</option>
                                </select>
                                <div class="form-text">Rotation angle for the display</div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary" :disabled="updating">
                                <span v-if="updating" class="spinner-border spinner-border-sm me-2"></span>
                                <i v-else class="bi bi-check-lg me-2"></i>
                                {{ updating ? 'Updating...' : 'Update Device' }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div class="modal fade" id="deleteModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title text-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Confirm Delete
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to delete this device?</p>
                        <div v-if="deletingDevice" class="card">
                            <div class="card-body">
                                <h6 class="card-title">{{ deletingDevice.device_friendly_name }}</h6>
                                <p class="card-text">
                                    <strong>Device ID:</strong> {{ deletingDevice.device_id }}<br>
                                    <strong>Firmware:</strong> v{{ deletingDevice.desired_firmware }}
                                </p>
                            </div>
                        </div>
                        <div class="alert alert-warning mt-3">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            This action cannot be undone.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" @click="deleteDevice" :disabled="deleting">
                            <span v-if="deleting" class="spinner-border spinner-border-sm me-2"></span>
                            <i v-else class="bi bi-trash me-2"></i>
                            {{ deleting ? 'Deleting...' : 'Delete Device' }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Vue.js -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    devices: [],
                    loading: false,
                    creating: false,
                    updating: false,
                    deleting: false,
                    message: '',
                    messageClass: 'alert-info',
                    messageIcon: 'bi-info-circle',

                    newDevice: {
                        device_id: '',
                        device_friendly_name: '',
                        desired_firmware: 100,
                        checkin_interval: 60,
                        image_url: null,
                        display_type: null,
                        rotation: 'ROTATE_0'
                    },

                    editingDevice: {},
                    deletingDevice: null,

                    // Modal instances
                    createModal: null,
                    editModal: null,
                    deleteModal: null
                }
            },

            async mounted() {
                // Initialize Bootstrap modals
                this.createModal = new bootstrap.Modal(document.getElementById('createModal'));
                this.editModal = new bootstrap.Modal(document.getElementById('editModal'));
                this.deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));

                // Load devices on startup
                await this.refreshDevices();
            },

            methods: {
                async refreshDevices() {
                    try {
                        const response = await fetch('/api/devices');
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);

                        this.devices = await response.json();
                    } catch (error) {
                        console.error('Failed to load devices:', error);
                        this.showMessage('Failed to load devices: ' + error.message, 'error');
                    }
                },

                showCreateModal() {
                    this.newDevice = {
                        device_id: '',
                        device_friendly_name: '',
                        desired_firmware: '0.0.0.10',
                        checkin_interval: 60,
                        image_url: null,
                        display_type: null,
                        rotation: 'ROTATE_0'
                    };
                    this.createModal.show();
                },

                async createDevice() {
                    this.creating = true;
                    let device = {...this.newDevice};
                    device.desired_firmware = this.unformatFirmware(this.newDevice.desired_firmware);
                    try {
                        const response = await fetch('/api/devices', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(device)
                        });

                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.error || `HTTP ${response.status}`);
                        }

                        await this.refreshDevices(true);
                        this.createModal.hide();
                        this.showMessage('Device created successfully', 'success');

                    } catch (error) {
                        console.error('Failed to create device:', error);
                        this.showMessage('Failed to create device: ' + error.message, 'error');
                    } finally {
                        this.creating = false;
                    }
                },

                editDevice(device) {
                    this.editingDevice = { ...device };
                    this.editingDevice.desired_firmware = this.formatFirmware(device.desired_firmware);
                    this.editModal.show();
                },

                async updateDevice() {
                    this.updating = true;

                    try {
                        const updateData = {
                            device_friendly_name: this.editingDevice.device_friendly_name,
                            desired_firmware: this.unformatFirmware(this.editingDevice.desired_firmware),
                            checkin_interval: this.editingDevice.checkin_interval,
                            image_url: this.editingDevice.image_url,
                            display_type: this.editingDevice.display_type,
                            rotation: this.editingDevice.rotation
                        };

                        const response = await fetch(`/api/devices/${this.editingDevice.device_id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(updateData)
                        });

                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.error || `HTTP ${response.status}`);
                        }

                        await this.refreshDevices(true);
                        this.editModal.hide();
                        this.showMessage('Device updated successfully', 'success');

                    } catch (error) {
                        console.error('Failed to update device:', error);
                        this.showMessage('Failed to update device: ' + error.message, 'error');
                    } finally {
                        this.updating = false;
                    }
                },

                confirmDelete(device) {
                    this.deletingDevice = device;
                    this.deleteModal.show();
                },

                async deleteDevice() {
                    this.deleting = true;

                    try {
                        const response = await fetch(`/api/devices/${this.deletingDevice.device_id}`, {
                            method: 'DELETE'
                        });

                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.error || `HTTP ${response.status}`);
                        }

                        await this.refreshDevices(true);
                        this.deleteModal.hide();
                        this.showMessage('Device deleted successfully', 'success');

                    } catch (error) {
                        console.error('Failed to delete device:', error);
                        this.showMessage('Failed to delete device: ' + error.message, 'error');
                    } finally {
                        this.deleting = false;
                    }
                },

                showMessage(text, type) {
                    this.message = text;

                    switch (type) {
                        case 'success':
                            this.messageClass = 'alert-success';
                            this.messageIcon = 'bi-check-circle';
                            break;
                        case 'error':
                            this.messageClass = 'alert-danger';
                            this.messageIcon = 'bi-exclamation-triangle';
                            break;
                        default:
                            this.messageClass = 'alert-info';
                            this.messageIcon = 'bi-info-circle';
                    }

                    // Auto-hide success messages
                    if (type === 'success') {
                        setTimeout(() => this.clearMessage(), 3000);
                    }
                },

                clearMessage() {
                    this.message = '';
                },

                getFirmwareIcon(state) {
                    switch (state) {
                        case 'OK': return 'bi-check-circle';
                        case 'PENDING': return 'bi-clock';
                        case 'STARTED': return 'bi-arrow-clockwise';
                        case 'FAILED': return 'bi-x-circle';
                        default: return 'bi-question-circle';
                    }
                },

                formatDisplayType(displayType) {
                    const displayTypeMap = {
                        'EPD_TYPE_GDEY029T71H': '2.9" B/W (GDEY029T71H)',
                        'EPD_TYPE_GDEM035F51': '3.5" 4-color (GDEM035F51)',
                        'EPD_TYPE_GDEY029F51': '2.9" 4-color (GDEY029F51)',
                        'EPD_TYPE_GDEM075F52': '7.5" 4-color (GDEM075F52)',
                        'EPD_TYPE_WS_75_V2B': '7.5" 2-color + red (WS_75_V2B)'
                    };
                    return displayTypeMap[displayType] || displayType;
                },
                formatRotation(rotation) {
                    const rotationMap = {
                        'ROTATE_0': '0°',
                        'ROTATE_90': '90°',
                        'ROTATE_180': '180°',
                        'ROTATE_270': '270°'
                    };
                    return rotationMap[rotation] || rotation;
                },
                formatFirmware(fwnumeric) {
                    let major = (fwnumeric & 0xFF000000) >> 24;
                    let minor = (fwnumeric & 0x00FF0000) >> 16;
                    let patch = (fwnumeric & 0x0000FF00) >> 8;
                    let tweak = (fwnumeric & 0x000000FF);
                    
                    return `${major}.${minor}.${patch}.${tweak}`;
                },
                unformatFirmware(fwstring) {
                    // '1.4.5.6'
                    let splitver = fwstring.split('.');
                    if (splitver.length != 4) {
                        throw new Error("invalid version number");
                    }
                    let realver = 0;
                    for (let i = 0; i < 4; i++) {
                        let comp = parseInt(splitver[i]);
                        console.log(comp, i, (3-i)*8);
                        if (isNaN(comp)) {
                            throw new Error("version contains non-numeric component");
                        }
                        if (comp > 255 || comp < 0) {
                            throw new Error("version contains > 255 or < 0");
                        }
                        realver |= (comp << ((3-i)*8));
                    }
                    return realver;
                },
                formatTimestamp(timestamp) {
                    const date = new Date(timestamp);
                    /*const now = new Date();
                    const diffMs = now - date;
                    const diffMins = Math.floor(diffMs / 60000);

                    if (diffMins < 1) return 'Just now';
                    if (diffMins < 60) return `${diffMins}m ago`;
                    if (diffMins < 1440) return `${Math.floor(diffMins / 60)}h ago`;*/

                    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                },

                isOverdue(expectedTimestamp) {
                    return new Date(expectedTimestamp) < new Date();
                }
            }
        }).mount('#app');
    </script>
</body>
</html>